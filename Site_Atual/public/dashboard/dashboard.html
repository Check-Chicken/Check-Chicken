<!DOCTYPE html>
<html lang="pt-br">

<head>
    <link rel="shortcut icon" href="../assets/imgs/logo_semfundo.png" type="image/x-icon">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap"
        rel="stylesheet">
    <title >Check Chicken - Dashboard </title>


    <link rel="stylesheet" href="./../css/dashboard.css">

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
        rel="stylesheet">

    <!-- scripts do Chart.js - 2022-1 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!--FONT AWESOME-->
    <script src="https://kit.fontawesome.com/9f7414eb10.js" crossorigin="anonymous"></script>
</head>

<body onload="obterDadosGrafico()">
    <script data-jsd-embedded data-key="793a0f03-074a-45ca-8c0e-7c5a79f4a6fa"
        data-base-url="https://jsd-widget.atlassian.com"
        src="https://jsd-widget.atlassian.com/assets/embed.js"></script>
    <nav>
        <div class="navbar">
            <div class="container nav-container">

                <div class="area_icone_tema">
                    <div class="icone_tema">

                        <button id="trocaCor" onclick="changeColor()"><img src="../assets/imgs/day-night.png"
                                alt=""></button>

                    </div>
                </div>
                <div class="menu-items">
                    <div class="logo">
                        <img src="../assets/imgs/logo_semfundo.png">
                    </div>
                    <div class="foto-usuario">

                        <p>Olá, <span id="nomeUsuario"> Usuário!</span></p>
                        <img src="../assets/imgs/mulher.png">
                        <p>Bem vindo(a) ao CheckChicken!</p>

                    </div>
                    <br>
                    <li><svg class="navIcon" viewBox="0 0 24.00 24.00" fill="none" xmlns="http://www.w3.org/2000/svg"
                            stroke="#dc9c42">
                            <g id="SVGRepo_bgCarrier" stroke-width="003366"></g>
                            <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"
                                stroke="#ff0000" stroke-width="0.144"></g>
                            <g id="SVGRepo_iconCarrier">
                                <path
                                    d="M16 7C16 9.2003366914 14.200336691 11 12 11C9.7900336686 11 8 9.2003366914 8 7C8 4.7900336686 9.7900336686 3 12 3C14.200336691 3 16 4.7900336686 16 7Z"
                                    stroke="003366" stroke-width="1.104" stroke-linecap="round" stroke-linejoin="round">
                                </path>
                                <path d="M12 14C8.1340033661 14 5 17.134 5 21H19C19 17.134 15.866 14 12 14Z"
                                    stroke="003366" stroke-width="1.104" stroke-linecap="round" stroke-linejoin="round">
                                </path>
                            </g>
                        </svg><a href="perfil.html">Editar Perfil</a>
                    </li>

                    <li><svg class="navIcon" viewBox="-2.4 -2.4 28.80 28.80" fill="none"
                            xmlns="http://www.w3.org/2000/svg" stroke="#000000" stroke-width="0.00024000000000000003">
                            <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                            <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"
                                stroke="#CCCCCC" stroke-width="0.384"></g>
                            <g id="SVGRepo_iconCarrier">
                                <path fill-rule="evenodd" clip-rule="evenodd"
                                    d="M22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12ZM12 7.75C11.3787 7.75 10.875 8.25368 10.875 8.875C10.875 9.28921 10.5392 9.625 10.125 9.625C9.71079 9.625 9.375 9.28921 9.375 8.875C9.375 7.42525 10.5503 6.25 12 6.25C13.4497 6.25 14.625 7.42525 14.625 8.875C14.625 9.58584 14.3415 10.232 13.883 10.704C13.7907 10.7989 13.7027 10.8869 13.6187 10.9708C13.4029 11.1864 13.2138 11.3753 13.0479 11.5885C12.8289 11.8699 12.75 12.0768 12.75 12.25V13C12.75 13.4142 12.4142 13.75 12 13.75C11.5858 13.75 11.25 13.4142 11.25 13V12.25C11.25 11.5948 11.555 11.0644 11.8642 10.6672C12.0929 10.3733 12.3804 10.0863 12.6138 9.85346C12.6842 9.78321 12.7496 9.71789 12.807 9.65877C13.0046 9.45543 13.125 9.18004 13.125 8.875C13.125 8.25368 12.6213 7.75 12 7.75ZM12 17C12.5523 17 13 16.5523 13 16C13 15.4477 12.5523 15 12 15C11.4477 15 11 15.4477 11 16C11 16.5523 11.4477 17 12 17Z"
                                    fill="#dc9c42"></path>
                            </g>
                        </svg><a href="dashboard.html"
                            style="font-weight: bold; text-decoration: underline;">Dashboard</a>
                    </li>


                    <li class="sair"><a href="..\index.html" onclick="sair()">Sair</a><svg class="navIcon"
                            viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                            <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                            <g id="SVGRepo_iconCarrier">
                                <g clip-path="url(#003366clip0_429_11067)">
                                    <path d="M15 4.00098H5V18.001C5 19.1055 5.89543 20.001 7 20.001H15" stroke="#dc9c42"
                                        stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></path>
                                    <path d="M16 15.001L19 12.001M19 12.001L16 9.00098M19 12.001H9" stroke="#dc9c42"
                                        stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></path>
                                </g>
                                <defs>
                                    <clipPath id="clip0_429_11067">
                                        <rect width="24" height="24" fill="white" transform="translate(0 0.000976562)">
                                        </rect>
                                    </clipPath>
                                </defs>
                            </g>
                        </svg>
                    </li>


                </div>
            </div>
        </div>
    </nav>
    <div class="corpo" id="corpo">
        <div class="tituloLegenda">Legenda
        </div>
        <div class="legenda">
            <div class="abaixo">Abaixo da temperatura ou umidade ideal</div>
            <div class="alerta">Temperatura ou umidade perto do limite</div>
            <div class="ideal">Temperatura e umidade ideais</div>
            <div class="acima">Temperatura ou umidade acima do ideal</div>
        
    </div>
        <div id="grid_corpo">
            <div id="corpo_kpi">
                <div id="kpi1">
                    <div id="titulo_kpi">Umidade atual do lote</div>
                    <div id="numeroQuestao" class="info_kpi" style="display: none;"></div>
                </div>
                <div id="kpi2">
                    <div id="titulo_kpi">Temp. atual do lote</div>
                    <div id="countdown" class="info_kpi" style="display: block;"></div>
                </div>
              
            </div>
            <div class="modal_encerrado" id="modal_encerramento">
                <form class="modal-content animate">
                    <h1>Tempo esgotado! :(</h1>
                    <h2>Deseja tentar mais uma vez?</h2>
                    <button class="botoes_encerrado" id="botao_recomecar" onclick="recomecar()">Recomeçar</button>
                    <button class="botoes_encerrado">Voltar</button>
                </form>


            </div>
            <div class="div_modal_regras" id="id_modal_regras">
                <div class="modal_regras animate" id="modal_regras">

                    <h1 style="text-decoration: underline; display: flex; justify-content: center;">Regras</h1>
                    <div class="topicos_regras">
                        <h2>
                            <li>Você terá 45 segundos por pergunta. </li>
                        </h2><br>
                        <h2>
                            <li>Cada uma das 10 perguntas terá 4 alternativas, mas só 1 resposta correta.</li>
                        </h2><br>
                        <h2>
                            <li>Caso acabe o tempo, você precisará reiniciar o quiz. </li>
                        </h2><br>
                        <h2>
                            <li>Você não poderá sair ou atualizar a página durante o quiz</li>
                        </h2><br>
                        <h2>
                            <li>Sua pontuação aparecerá ao final do quiz. </li>
                        </h2>

                    </div>
                    <h2 style="margin-left: 19.5vw; text-decoration: underline;">Boa Sorte!</h2>
                    <div class="corpo_botoes_regras">
                        <button class="botoes_encerrado" onclick="voltar()">Voltar</button>
                    </div>
                </div>

            </div>
            <div class="corpo_perguntas">
                <div class="grafico">
                    <div id="grafico" style="display: block; height: 55vh; width: 85vw; margin-left: 4vw;"><canvas
                            id="myChartTemp"></canvas></div>
                </div>
                <div class="grafico">
                    <div id="grafico" style="display: block; height: 55vh; width: 85vw; margin-left: 4vw;"><canvas
                            id="myChartUmi"></canvas></div>
                </div>

            </div>
        </div>
    </div>
</body>

</html>

<script>


    nomeUsuario.innerHTML = sessionStorage.NOME_USUARIO
    let idUsuario = sessionStorage.ID_USUARIO
    let idEmpresa = sessionStorage.ID_EMPRESA

    let proximaAtualizacao;

    function obterDadosGrafico() {

        if (proximaAtualizacao != undefined) {
            clearTimeout(proximaAtualizacao);
        }

        fetch(`/data/grafico/${idEmpresa}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);

                    plotarGrafico(resposta, idUsuario);

                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    let labelsTemp = [];
    let labelsUmi = [];

    function plotarGrafico(resposta, idUsuario) {

        console.log('iniciando plotagem do gráfico...');

        // Criando estrutura para plotar gráfico - labels


        // Criando estrutura para plotar gráfico - dados
        let dadosTemperatura = {
            labels: labelsTemp,
            datasets: [{
                label: 'Umidade',
                data: [],
                fill: false,
                backgroundColor: ['#2D5731'],
                borderWidth: 1,
                borderColor: '#FAE57F',
                tension: 0.1
            }]
        };

        let dadosUmidade = {
            labels: labelsUmi,
            datasets: [{
                label: 'Temperatura',
                data: [],
                fill: false,
                backgroundColor: ['#2D5731'],
                borderWidth: 1,
                borderColor: '#FAE57F',
                tension: 0.1
            }]
        };

        console.log('----------------------------------------------')
        console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
        console.log(resposta)
        console.log('----------------------------------------------')
        console.log(resposta.resultado[0].valor)

       

        tempReverse = resposta.resultado.reverse()
        umiReverse = resposta.resultado1.reverse()

        // Inserindo valores recebidos em estrutura para plotar o gráfico
        for (i = 0; i < resposta.resultado.length; i++) {
            var registroTemp = tempReverse[i]
            labelsTemp.push(registroTemp.dtMedicao);
            dadosTemperatura.datasets[0].data.push(registroTemp.valor);
        }

        for (i = 0; i < resposta.resultado1.length; i++) {
            var registroUmi = umiReverse[i]
            labelsUmi.push(registroUmi.dtMedicao);
            dadosUmidade.datasets[0].data.push(registroUmi.valor);
        }

        console.log('----------------------------------------------')
        console.log('O gráfico será plotado com os respectivos valores:')
        console.log('Labels:')
        console.log(labelsTemp)
        console.log('Dados:')
        console.log(dadosTemperatura.datasets)
        console.log('----------------------------------------------')

        // Criando estrutura para plotar gráfico - config
        const configTemperatura = {
            type: 'line',
            data: dadosTemperatura,
            options: {
                scales: {
                    y: {
                        grid: {
                            display: false
                        },
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1,
                        }
                    }
                }
            }
        };

        const configUmidade = {
            type: 'line',
            data: dadosUmidade,
            options: {
                scales: {
                    y: {
                        grid: {
                            display: false
                        },
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1,
                        }
                    }
                }
            }
        };

        // Adicionando gráfico criado em div na tela
        let myChartTemp = new Chart(
            document.getElementById(`myChartTemp`),
            configTemperatura
        );

        let myChartUmi = new Chart(
            document.getElementById(`myChartUmi`),
            configUmidade
        );

   

        setTimeout(() => atualizarGrafico(dadosTemperatura, dadosUmidade, myChartTemp, myChartUmi), 2000);
    }

    // funcao para alterar a cor da caixa dependendo do valor capturado
function alterarCorTemp(valor, caixa) {
    // Seleciona a caixa pela classe e define a cor com base no valor 
    if (valor >= 35) {
        caixa.style.backgroundColor = '#FF5151';
    } else if (valor >= 32.1 && valor <=33.9) {
        caixa.style.backgroundColor = '#4BB262';
    } else if (valor <= 32 || valor >= 34) {
        caixa.style.backgroundColor = '#F5B91E';
    }else{
        caixa.style.backgroundColor = '#4BAFE8';
    }
}
function alterarCorUmid(valor, caixa) {
    // Seleciona a caixa pela classe e define a cor com base no valor
    if (valor > 70) {
        caixa.style.backgroundColor = '#FF5151';
    } else if (valor >= 60 && valor <=70) {
        caixa.style.backgroundColor = '#4BB262';
    } else if (valor >=67 && valor<=55) {
        caixa.style.backgroundColor = '#F5B91E';
    }else{
        caixa.style.backgroundColor = '#4BAFE8';
    }
}

    function atualizarGrafico(dadosTemperatura, dadosUmidade, myChartTemp, myChartUmi) {

        fetch(`/data/tempoReal/${idEmpresa}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (novoRegistro) {

                    // alertar(novoRegistro, idEmpresa);
                    console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
                    console.log(`Dados atuais do gráfico:`);
                    console.log(dadosTemperatura, dadosUmidade);

                    // let avisoCaptura = document.getElementById(`avisoCaptura${idEmpresa}`)
                    // avisoCaptura.innerHTML = "" 

                    let temperaturaAtual = 0;
                    let umidadeAtual = 0;

                 

                    if (novoRegistro.resultado[0].dtMedicao == dadosTemperatura.labels[labelsTemp.length - 1]) {
                        console.log("---------------------------------------------------------------")
                        console.log("Como não há dados de temperatura novos para captura, o gráfico de temperatura não atualizará.")
                        // avisoCaptura.innerHTML = "<i class='fa-solid fa-triangle-exclamation'></i> Foi trazido o dado mais atual capturado pelo sensor. <br> Como não há dados novos a exibir, o gráfico não atualizará."
                        console.log("Horário do novo dado capturado:")
                        console.log(novoRegistro.resultado[0].dtMedicao)
                        console.log("Horário do último dado capturado:")
                        console.log(dadosTemperatura.labels[labelsTemp.length - 1])
                        console.log("---------------------------------------------------------------")
                    } else {
                        // tirando e colocando valores no gráfico
                        dadosTemperatura.labels.shift(); // apagar o primeiro
                        dadosTemperatura.labels.push(novoRegistro.resultado[0].dtMedicao); // incluir um novo momento

                        dadosTemperatura.datasets[0].data.shift();  // apagar o primeiro de temperatura
                        dadosTemperatura.datasets[0].data.push(novoRegistro.resultado[0].valor); // incluir uma nova medida de temperatura

                        temperaturaAtual = novoRegistro.resultado[0].valor;

                        numeroQuestao.innerHTML = temperaturaAtual;

                        myChartTemp.update();
                    }
                    

                    if (novoRegistro.resultado1[0].dtMedicao == dadosUmidade.labels[labelsUmi.length - 1]) {
                        console.log("---------------------------------------------------------------")
                        console.log("Como não há dados de umidade novos para captura, o gráfico de umidade não atualizará.")
                        // avisoCaptura.innerHTML = "<i class='fa-solid fa-triangle-exclamation'></i> Foi trazido o dado mais atual capturado pelo sensor. <br> Como não há dados novos a exibir, o gráfico não atualizará."
                        console.log("Horário do novo dado capturado:")
                        console.log(novoRegistro.resultado1[0].dtMedicao)
                        console.log("Horário do último dado capturado:")
                        console.log(dadosUmidade.labels[labelsUmi.length - 1])
                        console.log("último dado capturado:")
                        console.log(novoRegistro.resultado1[0].valor)
                        console.log("---------------------------------------------------------------")
                    } else {
                        // tirando e colocando valores no gráfico
                        dadosUmidade.labels.shift(); // apagar o primeiro
                        dadosUmidade.labels.push(novoRegistro.resultado1[0].dtMedicao); // incluir um novo momento

                        dadosUmidade.datasets[0].data.shift();  // apagar o primeiro de umidade
                        dadosUmidade.datasets[0].data.push(novoRegistro.resultado1[0].valor); // incluir uma nova medida de umidade

                        umidadeAtual = novoRegistro.resultado1[0].valor;

                        myChartUmi.update();

                        countdown.innerHTML = umidadeAtual;
                    }
                    alterarCorTemp(temperaturaAtual, document.getElementById('countdown'));
                    alterarCorUmid(umidadeAtual, document.getElementById('numeroQuestao'));


                    // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                    proximaAtualizacao = setTimeout(() => atualizarGrafico(dadosTemperatura, dadosUmidade, myChartTemp, myChartUmi), 2000);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
                // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                proximaAtualizacao = setTimeout(() => atualizarGrafico(dadosTemperatura, dadosUmidade, myChartTemp, myChartUmi), 2000);
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });

    }

    // function obterKpis() {
    //     fetch(`/data/kpi/${idEmpresa}`, { cache: 'no-store' }).then(function (response) {
    //         if (response.ok) {
    //             response.json().then(function (resposta) {
    //                 console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
    //             });
    //         } else {
    //             console.error('Nenhum dado encontrado ou erro na API');
    //         }
    //     })
    //         .catch(function (error) {
    //             console.error(`Erro na obtenção dos dados p/ Kpi's: ${error.message}`);
    //         });
    // }


    function regras() {
        document.querySelector('.modal_regras').style.display = 'flex';
    }

    function voltar() {
        document.querySelector('.modal_regras').style.display = 'none';
    }

    function sair() {
        sessionStorage.clear();
        window.location = "../index.html";
    }

</script>